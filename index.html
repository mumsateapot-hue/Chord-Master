<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chord Master</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#30e3ca">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Chord Master">
    
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
            color: #e4e4e4; 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            min-height: 100vh;
            touch-action: manipulation; 
        }
        .container { 
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 30px; 
            border-radius: 20px; 
            text-align: center; 
            width: 100%; 
            max-width: 500px; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: box-shadow 0.3s ease;
        }
        
        h2 { 
            margin: 0 0 20px 0; 
            font-size: 2rem; 
            font-weight: 300;
            letter-spacing: 2px;
        }
        
        /* Menu Screen Styles */
        .menu-section {
            margin: 30px 0;
        }
        
        .menu-section h3 {
            font-size: 1.2rem;
            font-weight: 400;
            margin-bottom: 15px;
            color: #64dfdf;
            letter-spacing: 1px;
        }
        
        .selection-bar { 
            display: flex; 
            gap: 12px; 
            margin-bottom: 15px; 
            background: rgba(0, 0, 0, 0.3); 
            padding: 8px; 
            border-radius: 12px; 
        }
        
        .selection-btn { 
            flex: 1; 
            padding: 16px 12px; 
            border-radius: 10px; 
            border: none; 
            font-weight: 600; 
            font-size: 0.9rem; 
            cursor: pointer; 
            color: white; 
            opacity: 0.5; 
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }
        
        .selection-btn:hover { opacity: 0.7; }
        .selection-btn.selected { 
            opacity: 1; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
        }
        
        .selection-btn.selected::after {
            content: '‚úì';
            position: absolute;
            top: 4px;
            right: 8px;
            font-size: 1rem;
        }
        
        .easy { 
            background: linear-gradient(135deg, rgba(86, 171, 47, 0.3) 0%, rgba(168, 224, 99, 0.3) 100%);
            border: 1px solid rgba(168, 224, 99, 0.4);
        }
        .medium { 
            background: linear-gradient(135deg, rgba(242, 153, 74, 0.3) 0%, rgba(242, 201, 76, 0.3) 100%);
            border: 1px solid rgba(242, 201, 76, 0.4);
        }
        .hard { 
            background: linear-gradient(135deg, rgba(235, 51, 73, 0.3) 0%, rgba(244, 92, 67, 0.3) 100%);
            border: 1px solid rgba(244, 92, 67, 0.4);
        }
        .one-hand { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .two-hand { background: linear-gradient(135deg, #30e3ca 0%, #48b9b9 100%); }
        
        .start-btn {
            background: linear-gradient(135deg, #30e3ca 0%, #48b9b9 100%);
            color: #1a1a2e;
            padding: 18px 40px;
            border-radius: 12px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            letter-spacing: 1px;
            margin-top: 20px;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        
        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(48, 227, 202, 0.5);
        }
        
        .start-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Game Screen Styles */
        .notes-display { 
            font-size: 2rem; 
            font-weight: 300; 
            color: #64dfdf; 
            margin: 20px 0; 
            min-height: 2.5rem;
            letter-spacing: 4px;
            white-space: nowrap;
        }
        
        .notes-display.compact {
            font-size: 1.5rem;
            letter-spacing: 2px;
        }
        
        .notes-display.very-compact {
            font-size: 1.2rem;
            letter-spacing: 1px;
        }
        
        /* Piano */
        .piano { 
            display: flex; 
            justify-content: center; 
            height: 100px; 
            margin: 20px 0 30px 0; 
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
        }
        .key { 
            border: 1px solid #000; 
            height: 100%; 
            width: 34px; 
            background: linear-gradient(180deg, #ffffff 0%, #f0f0f0 100%); 
            border-radius: 0 0 6px 6px; 
            cursor: pointer; 
            position: relative; 
            transition: all 0.1s ease;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 4px;
        }
        .key-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: #666;
            user-select: none;
        }
        .key-label.hidden-label {
            display: none;
        }
        .key:hover { background: linear-gradient(180deg, #f0f0f0 0%, #e0e0e0 100%); }
        .key.black { 
            background: linear-gradient(180deg, #2c2c2c 0%, #1a1a1a 100%); 
            height: 65%; 
            width: 24px; 
            margin-left: -12px; 
            margin-right: -12px; 
            z-index: 2; 
            border-radius: 0 0 4px 4px;
            padding-bottom: 3px;
        }
        .key.black .key-label {
            font-size: 0.55rem;
            color: #888;
        }
        .key.black:hover { background: linear-gradient(180deg, #3c3c3c 0%, #2a2a2a 100%); }
        .key.highlight { 
            background: linear-gradient(180deg, #64dfdf 0%, #48b9b9 100%) !important; 
            border-top: 4px solid #30e3ca;
        }
        .key.active { 
            background: linear-gradient(180deg, #30e3ca 0%, #20c9b0 100%) !important; 
        }

        /* Musical Keyboard Styles */
        .answer-section {
            margin: 25px 0;
        }
        
        .answer-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 2px;
            color: #64dfdf;
        }
        
        .note-keyboard {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .note-btn {
            padding: 16px 8px;
            border-radius: 10px;
            border: 2px solid rgba(100, 223, 223, 0.3);
            background: rgba(100, 223, 223, 0.1);
            color: #64dfdf;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
        }
        
        .note-btn:hover {
            background: rgba(100, 223, 223, 0.2);
            border-color: rgba(100, 223, 223, 0.5);
            transform: translateY(-2px);
        }
        
        .note-btn.selected {
            background: linear-gradient(135deg, #30e3ca 0%, #48b9b9 100%);
            border-color: #30e3ca;
            color: #1a1a2e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(48, 227, 202, 0.4);
        }
        
        .chord-type-keyboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .chord-type-btn {
            padding: 14px 8px;
            border-radius: 10px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .chord-type-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }
        
        .chord-type-btn.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .controls { 
            display: flex; 
            gap: 10px; 
            justify-content: center; 
            margin: 20px 0; 
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, #30e3ca 0%, #48b9b9 100%);
            color: #1a1a2e;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(48, 227, 202, 0.4);
        }
        
        .btn-secondary { 
            background: rgba(255, 255, 255, 0.1);
            color: #e4e4e4;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, rgba(235, 51, 73, 0.3) 0%, rgba(244, 92, 67, 0.3) 100%);
            color: #e4e4e4;
            border: 1px solid rgba(244, 92, 67, 0.4);
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, rgba(235, 51, 73, 0.4) 0%, rgba(244, 92, 67, 0.4) 100%);
            transform: translateY(-2px);
        }
        
        .streak-display {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }
        
        .streak-item {
            text-align: center;
        }
        
        .streak-label {
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .streak-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #64dfdf;
        }
        
        #feedback { 
            margin: 15px 0; 
            font-size: 1.1rem; 
            font-weight: 600; 
            min-height: 1.5rem;
            letter-spacing: 0.5px;
        }
        
        #hint-display { 
            margin: 10px 0; 
            font-size: 0.95rem; 
            color: #f2c94c; 
            min-height: 1.2rem;
        }
        
        #explanation { 
            margin: 15px 0; 
            font-size: 0.9rem; 
            line-height: 1.6; 
            color: #b0b0b0; 
            text-align: left; 
            padding: 15px; 
            background: rgba(0, 0, 0, 0.2); 
            border-radius: 10px; 
            border-left: 4px solid #30e3ca;
        }
        
        .screen { display: none; }
        .screen.active { display: block; }
        
        @keyframes pulse-correct {
            0%, 100% { box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
            50% { box-shadow: 0 8px 32px rgba(46, 204, 113, 0.6); }
        }
        
        @keyframes pulse-wrong {
            0%, 100% { box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); }
            50% { box-shadow: 0 8px 32px rgba(231, 76, 60, 0.6); }
        }
        
        .container.pulse-correct {
            animation: pulse-correct 0.5s ease;
        }
        
        .container.pulse-wrong {
            animation: pulse-wrong 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Menu Screen -->
        <div id="menu-screen" class="screen active">
            <h2>üéπ CHORD MASTER</h2>
            
            <div class="menu-section">
                <h3>Difficulty</h3>
                <div class="selection-bar">
                    <button class="selection-btn easy selected" onclick="selectDifficulty('easy')">Easy</button>
                    <button class="selection-btn medium" onclick="selectDifficulty('medium')">Medium</button>
                    <button class="selection-btn hard" onclick="selectDifficulty('hard')">Hard</button>
                </div>
            </div>
            
            <div class="menu-section">
                <h3>Hand Mode</h3>
                <div class="selection-bar">
                    <button class="selection-btn one-hand selected" onclick="selectHandMode('one')">One Hand</button>
                    <button class="selection-btn two-hand" onclick="selectHandMode('two')">Two Hands</button>
                </div>
            </div>
            
            <button class="start-btn" onclick="startGame()">Start Game</button>
        </div>
        
        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <h2>üéπ CHORD MASTER</h2>
            
            <div class="streak-display">
                <div class="streak-item">
                    <div class="streak-label">Current Streak</div>
                    <div class="streak-value" id="current-streak">0</div>
                </div>
                <div class="streak-item">
                    <div class="streak-label">Best Streak</div>
                    <div class="streak-value" id="max-streak">0</div>
                </div>
            </div>
            
            <div class="notes-display" id="notes-display">‚ô™ ‚ô™ ‚ô™</div>
            <div class="piano" id="piano"></div>
            
            <div class="answer-section">
                <div class="answer-display" id="answer-display">Select a note and chord type</div>
                
                <div class="note-keyboard" id="note-keyboard"></div>
                
                <div class="chord-type-keyboard" id="chord-type-keyboard"></div>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="checkAnswer()">Check Answer</button>
                <button class="btn btn-secondary" onclick="playCurrentChord()">üîä Play Chord</button>
                <button class="btn btn-secondary" onclick="showHint()">üí° Hint</button>
                <button class="btn btn-secondary" onclick="generateChord()">‚è≠ Next Chord</button>
                <button class="btn btn-danger" onclick="giveUp()">Give Up</button>
            </div>
            
            <div id="feedback"></div>
            <div id="hint-display"></div>
            <div id="explanation"></div>
            
            <div style="margin-top: 30px;">
                <button class="btn btn-secondary" onclick="showMenu()">‚Üê Back to Menu</button>
            </div>
        </div>
    </div>

<script>
    var NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    var NOTES_TWO_OCTAVE = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B',
                            'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    
    var CHORD_TYPES = {
        easy: ['Major', 'Minor'],
        medium: ['Major', 'Minor', 'Diminished', 'Augmented', '7', 'Major 7th', 'Minor 7th'],
        hard: ['Major', 'Minor', 'Diminished', 'Augmented', '7', 'Major 7th', 'Minor 7th', 
               '9', 'Major 9th', 'Minor 9th', '11', '13', 'Sus2', 'Sus4', 'Add9', '6', 'Minor 6th']
    };
    
    var CHORD_TYPE_BUTTONS = {
        easy: [
            { label: 'Maj', type: 'Major' },
            { label: 'min', type: 'Minor' }
        ],
        medium: [
            { label: 'Maj', type: 'Major' },
            { label: 'min', type: 'Minor' },
            { label: 'dim', type: 'Diminished' },
            { label: 'aug', type: 'Augmented' },
            { label: '7', type: '7' },
            { label: 'Maj7', type: 'Major 7th' },
            { label: 'min7', type: 'Minor 7th' }
        ],
        hard: [
            { label: 'Maj', type: 'Major' },
            { label: 'min', type: 'Minor' },
            { label: 'dim', type: 'Diminished' },
            { label: 'aug', type: 'Augmented' },
            { label: '7', type: '7' },
            { label: 'Maj7', type: 'Major 7th' },
            { label: 'min7', type: 'Minor 7th' },
            { label: '9', type: '9' },
            { label: 'Maj9', type: 'Major 9th' },
            { label: 'min9', type: 'Minor 9th' },
            { label: '11', type: '11' },
            { label: '13', type: '13' },
            { label: 'sus2', type: 'Sus2' },
            { label: 'sus4', type: 'Sus4' },
            { label: 'add9', type: 'Add9' },
            { label: '6', type: '6' },
            { label: 'min6', type: 'Minor 6th' }
        ]
    };
    
    var CHORD_INTERVALS = {
        'Major': [0, 4, 7],
        'Minor': [0, 3, 7],
        'Diminished': [0, 3, 6],
        'Augmented': [0, 4, 8],
        '7': [0, 4, 7, 10],
        'Major 7th': [0, 4, 7, 11],
        'Minor 7th': [0, 3, 7, 10],
        '9': [0, 4, 7, 10, 14],
        'Major 9th': [0, 4, 7, 11, 14],
        'Minor 9th': [0, 3, 7, 10, 14],
        '11': [0, 4, 7, 10, 14, 17],
        '13': [0, 4, 7, 10, 14, 21],
        'Sus2': [0, 2, 7],
        'Sus4': [0, 5, 7],
        'Add9': [0, 4, 7, 14],
        '6': [0, 4, 7, 9],
        'Minor 6th': [0, 3, 7, 9]
    };
    
    var audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    var state = {
        difficulty: 'easy',
        handMode: 'one',
        root: '',
        type: '',
        notes: [],
        hintLevel: 0,
        currentStreak: 0,
        maxStreak: 0,
        selectedNote: null,
        selectedChordType: null
    };
    
    function selectDifficulty(level) {
        state.difficulty = level;
        document.querySelectorAll('.selection-btn.easy, .selection-btn.medium, .selection-btn.hard')
            .forEach(function(btn) { btn.classList.remove('selected'); });
        document.querySelector('.selection-btn.' + level).classList.add('selected');
    }
    
    function selectHandMode(mode) {
        state.handMode = mode;
        document.querySelectorAll('.selection-btn.one-hand, .selection-btn.two-hand')
            .forEach(function(btn) { btn.classList.remove('selected'); });
        document.querySelector('.selection-btn.' + (mode === 'one' ? 'one-hand' : 'two-hand')).classList.add('selected');
    }
    
    function showMenu() {
        document.getElementById('menu-screen').classList.add('active');
        document.getElementById('game-screen').classList.remove('active');
    }
    
    function startGame() {
        document.getElementById('menu-screen').classList.remove('active');
        document.getElementById('game-screen').classList.add('active');
        setupPiano();
        setupNoteKeyboard();
        setupChordTypeKeyboard();
        generateChord();
    }
    
    function setupPiano() {
        var piano = document.getElementById('piano');
        piano.innerHTML = '';
        
        var notes = state.handMode === 'two' ? NOTES_TWO_OCTAVE : NOTES;
        var pattern = [0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0];
        
        for (var i = 0; i < notes.length; i++) {
            var key = document.createElement('div');
            var isBlack = pattern[i % 12] === 1;
            key.className = 'key' + (isBlack ? ' black' : '');
            key.setAttribute('data-index', i);
            
            var label = document.createElement('div');
            label.className = 'key-label';
            label.innerText = notes[i];
            key.appendChild(label);
            
            key.onclick = (function(idx) {
                return function() { playNote(idx); };
            })(i);
            
            piano.appendChild(key);
        }
    }
    
    function setupNoteKeyboard() {
        var keyboard = document.getElementById('note-keyboard');
        keyboard.innerHTML = '';
        
        NOTES.forEach(function(note) {
            var btn = document.createElement('button');
            btn.className = 'note-btn';
            btn.innerText = note;
            btn.onclick = function() { selectNote(note); };
            keyboard.appendChild(btn);
        });
    }
    
    function setupChordTypeKeyboard() {
        var keyboard = document.getElementById('chord-type-keyboard');
        keyboard.innerHTML = '';
        
        var buttons = CHORD_TYPE_BUTTONS[state.difficulty];
        buttons.forEach(function(btnData) {
            var btn = document.createElement('button');
            btn.className = 'chord-type-btn';
            btn.innerText = btnData.label;
            btn.setAttribute('data-type', btnData.type);
            btn.onclick = function() { selectChordType(btnData.type); };
            keyboard.appendChild(btn);
        });
    }
    
    function selectNote(note) {
        state.selectedNote = note;
        
        // Update UI
        document.querySelectorAll('.note-btn').forEach(function(btn) {
            btn.classList.remove('selected');
        });
        event.target.classList.add('selected');
        
        updateAnswerDisplay();
    }
    
    function selectChordType(type) {
        state.selectedChordType = type;
        
        // Update UI
        document.querySelectorAll('.chord-type-btn').forEach(function(btn) {
            btn.classList.remove('selected');
        });
        event.target.classList.add('selected');
        
        updateAnswerDisplay();
    }
    
    function updateAnswerDisplay() {
        var display = document.getElementById('answer-display');
        
        if (!state.selectedNote && !state.selectedChordType) {
            display.innerText = 'Select a note and chord type';
        } else if (!state.selectedNote) {
            display.innerText = 'Select a root note';
        } else if (!state.selectedChordType) {
            display.innerText = state.selectedNote + ' - Select chord type';
        } else {
            display.innerText = formatChordName(state.selectedNote, state.selectedChordType);
        }
    }
    
    function playNote(index) {
        var notes = state.handMode === 'two' ? NOTES_TWO_OCTAVE : NOTES;
        var octaveOffset = state.handMode === 'two' && index >= 12 ? 12 : 0;
        var baseFreq = 261.63;
        var freq = baseFreq * Math.pow(2, (index - octaveOffset) / 12);
        
        var oscillator = audioContext.createOscillator();
        var gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = freq;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
        
        var keys = document.querySelectorAll('.key');
        if (keys[index]) {
            keys[index].classList.add('active');
            setTimeout(function() {
                keys[index].classList.remove('active');
            }, 200);
        }
    }
    
    function generateChord() {
        var chordTypes = CHORD_TYPES[state.difficulty];
        state.type = chordTypes[Math.floor(Math.random() * chordTypes.length)];
        state.root = NOTES[Math.floor(Math.random() * NOTES.length)];
        
        var rootIndex = NOTES.indexOf(state.root);
        var intervals = CHORD_INTERVALS[state.type];
        
        state.notes = [];
        var useTwoOctave = state.handMode === 'two';
        
        for (var i = 0; i < intervals.length; i++) {
            var noteIndex = (rootIndex + intervals[i]) % 12;
            var octaveShift = Math.floor((rootIndex + intervals[i]) / 12);
            
            if (useTwoOctave && octaveShift > 0) {
                state.notes.push(NOTES_TWO_OCTAVE[noteIndex + 12]);
            } else {
                state.notes.push(NOTES[noteIndex]);
            }
        }
        
        // Reset UI
        state.selectedNote = null;
        state.selectedChordType = null;
        document.querySelectorAll('.note-btn').forEach(function(btn) {
            btn.classList.remove('selected');
        });
        document.querySelectorAll('.chord-type-btn').forEach(function(btn) {
            btn.classList.remove('selected');
        });
        updateAnswerDisplay();
        
        var notesText = state.notes.join(' - ');
        var display = document.getElementById('notes-display');
        display.innerText = notesText;
        
        if (notesText.length > 30) {
            display.className = 'notes-display very-compact';
        } else if (notesText.length > 20) {
            display.className = 'notes-display compact';
        } else {
            display.className = 'notes-display';
        }
        
        document.getElementById('feedback').innerText = '';
        document.getElementById('hint-display').innerText = '';
        document.getElementById('explanation').innerHTML = '';
        state.hintLevel = 0;
        
        highlightChordKeys();
        playCurrentChord();
    }
    
    function highlightChordKeys() {
        var keys = document.querySelectorAll('.key');
        keys.forEach(function(k) { k.classList.remove('highlight'); });
        
        var notes = state.handMode === 'two' ? NOTES_TWO_OCTAVE : NOTES;
        
        state.notes.forEach(function(noteName) {
            var idx = notes.indexOf(noteName);
            if (idx !== -1 && keys[idx]) {
                keys[idx].classList.add('highlight');
            }
        });
    }
    
    function getChordExplanation(root, type) {
        var rootIndex = NOTES.indexOf(root);
        var intervals = CHORD_INTERVALS[type];
        var noteNames = [];
        
        for (var i = 0; i < intervals.length; i++) {
            var noteIndex = (rootIndex + intervals[i]) % 12;
            noteNames.push(NOTES[noteIndex]);
        }
        
        var explanations = {
            'Major': 'A major triad built with a major third (4 semitones) and a perfect fifth (7 semitones).',
            'Minor': 'A minor triad with a minor third (3 semitones) and a perfect fifth (7 semitones).',
            'Diminished': 'A diminished triad with a minor third (3 semitones) and a diminished fifth (6 semitones).',
            'Augmented': 'An augmented triad with a major third (4 semitones) and an augmented fifth (8 semitones).',
            '7': 'A dominant seventh chord: major triad plus a minor seventh (10 semitones from root).',
            'Major 7th': 'A major seventh chord: major triad plus a major seventh (11 semitones from root).',
            'Minor 7th': 'A minor seventh chord: minor triad plus a minor seventh (10 semitones from root).',
            '9': 'A dominant ninth chord: dominant 7th plus a major ninth (14 semitones, or 2nd octave D).',
            'Major 9th': 'A major ninth chord: major 7th plus a major ninth.',
            'Minor 9th': 'A minor ninth chord: minor 7th plus a major ninth.',
            '11': 'A dominant eleventh chord: extends the 9th chord with an 11th (17 semitones).',
            '13': 'A dominant thirteenth chord: extends further with a major 13th (21 semitones).',
            'Sus2': 'A suspended chord replacing the third with the major second (2 semitones).',
            'Sus4': 'A suspended chord replacing the third with the perfect fourth (5 semitones).',
            'Add9': 'A major triad with an added ninth, without the seventh.',
            '6': 'A major sixth chord: major triad plus a major sixth (9 semitones).',
            'Minor 6th': 'A minor sixth chord: minor triad plus a major sixth (9 semitones).'
        };
        
        return "<strong>" + root + " " + type + ":</strong> " + noteNames.join(" - ") + "<br>" + explanations[type];
    }
    
    function playCurrentChord() {
        state.notes.forEach(function(name, i) {
            setTimeout(function() { 
                var notes = state.handMode === 'two' ? NOTES_TWO_OCTAVE : NOTES;
                var idx = notes.indexOf(name);
                if (idx !== -1) playNote(idx);
            }, i * 60);
        });
        
        setTimeout(function() {
            highlightChordKeys();
        }, state.notes.length * 60 + 100);
    }
    
    function vibrate(pattern) {
        if ('vibrate' in navigator) {
            navigator.vibrate(pattern);
        }
    }
    
    function showHint() {
        var hintDisplay = document.getElementById('hint-display');
        
        if (state.hintLevel === 0) {
            hintDisplay.innerText = "Hint 1: The root note is " + state.root;
            state.hintLevel = 1;
        } else if (state.hintLevel === 1) {
            var category = "";
            if (state.type === "Major") category = "a Major chord";
            else if (state.type === "Minor") category = "a Minor chord";
            else if (state.type === "Diminished") category = "a Diminished chord";
            else if (state.type === "Augmented") category = "an Augmented chord";
            else if (state.type === "7") category = "a Dominant 7th chord";
            else if (state.type === "Major 7th") category = "a Major 7th chord";
            else if (state.type === "Minor 7th") category = "a Minor 7th chord";
            else if (state.type === "9") category = "a Dominant 9th chord";
            else if (state.type === "Major 9th") category = "a Major 9th chord";
            else if (state.type === "Minor 9th") category = "a Minor 9th chord";
            else if (state.type === "11") category = "a Dominant 11th chord";
            else if (state.type === "13") category = "a Dominant 13th chord";
            else if (state.type === "Sus2") category = "a Suspended 2nd chord";
            else if (state.type === "Sus4") category = "a Suspended 4th chord";
            else if (state.type === "Add9") category = "an Add9 chord";
            else if (state.type === "6") category = "a Major 6th chord";
            else if (state.type === "Minor 6th") category = "a Minor 6th chord";
            
            hintDisplay.innerText = "Hint 2: It's " + category;
            state.hintLevel = 2;
        } else if (state.hintLevel === 2) {
            var answer = formatChordName(state.root, state.type);
            hintDisplay.innerText = "Answer: " + answer;
            document.getElementById('explanation').innerHTML = getChordExplanation(state.root, state.type);
            document.getElementById('feedback').innerText = "";
            state.hintLevel = 3;
        } else {
            hintDisplay.innerText = "No more hints! Try the next chord.";
        }
    }
    
    function giveUp() {
        var answer = formatChordName(state.root, state.type);
        document.getElementById('feedback').innerText = "The answer was: " + answer;
        document.getElementById('feedback').style.color = "#f2c94c";
        document.getElementById('explanation').innerHTML = getChordExplanation(state.root, state.type);
        document.getElementById('hint-display').innerText = "";
        playCurrentChord();
    }
    
    function normalizeNote(note) {
        var noteMap = {
            'Db': 'C#', 'C#': 'C#',
            'Eb': 'D#', 'D#': 'D#',
            'Gb': 'F#', 'F#': 'F#',
            'Ab': 'G#', 'G#': 'G#',
            'Bb': 'A#', 'A#': 'A#',
            'C': 'C', 'D': 'D', 'E': 'E', 'F': 'F', 'G': 'G', 'A': 'A', 'B': 'B'
        };
        return noteMap[note] || note;
    }
    
    function checkAnswer() {
        if (!state.selectedNote || !state.selectedChordType) {
            document.getElementById('feedback').innerText = "Please select both a note and chord type!";
            document.getElementById('feedback').style.color = "#f2c94c";
            return;
        }
        
        var feedback = document.getElementById('feedback');
        var explanation = document.getElementById('explanation');
        var container = document.querySelector('.container');
        
        container.classList.remove('pulse-correct', 'pulse-wrong');
        
        var normalizedUserRoot = normalizeNote(state.selectedNote);
        var normalizedActualRoot = normalizeNote(state.root);
        
        if (normalizedUserRoot === normalizedActualRoot && state.selectedChordType === state.type) {
            // Correct answer
            state.currentStreak++;
            if (state.currentStreak > state.maxStreak) {
                state.maxStreak = state.currentStreak;
            }
            updateStreakDisplay();
            
            feedback.innerText = "Correct! üéâ";
            feedback.style.color = "#2ecc71";
            explanation.innerHTML = getChordExplanation(state.root, state.type);
            document.getElementById('hint-display').innerText = "";
            
            void container.offsetWidth;
            container.classList.add('pulse-correct');
            
            // Vibrate on correct answer (short happy pulse)
            vibrate([100, 50, 100]);
            
            playCurrentChord();
        } else {
            // Wrong answer
            state.currentStreak = 0;
            updateStreakDisplay();
            
            feedback.innerText = "Try again!";
            feedback.style.color = "#e74c3c";
            explanation.innerHTML = "";
            
            void container.offsetWidth;
            container.classList.add('pulse-wrong');
            
            // Vibrate on incorrect answer (longer error pattern)
            vibrate([100, 100, 100, 100, 100]);
        }
    }
    
    function updateStreakDisplay() {
        document.getElementById('current-streak').innerText = state.currentStreak;
        document.getElementById('max-streak').innerText = state.maxStreak;
    }
    
    function formatChordName(root, type) {
        var shorthand = type
            .replace("Major 7th", "maj7")
            .replace("Major 9th", "maj9")
            .replace("Minor 7th", "m7")
            .replace("Minor 9th", "m9")
            .replace("Minor 6th", "m6")
            .replace("Minor", "m")
            .replace("Diminished", "dim")
            .replace("Augmented", "aug")
            .replace("Sus2", "sus2")
            .replace("Sus4", "sus4")
            .replace("Add9", "add9");
        return root + (type === "Major" ? "" : shorthand);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Register service worker for offline support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(function(registration) {
                    console.log('Service Worker registered successfully:', registration.scope);
                })
                .catch(function(error) {
                    console.log('Service Worker registration failed:', error);
                });
        }
    });
</script>
</body>
</html>
